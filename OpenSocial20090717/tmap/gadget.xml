<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs
     title="Avatt"
     description="map"
     author="Yusuke Hashimoto"
     screenshot=""
     thumbnail="">
    <Require feature="opensocial-0.8"/>
    <Require feature="dynamic-height"/>
    <Require feature="tabs"/>
    <Require feature="settitle"/>
    <Require feature="minimessage"/>
    <Optional feature="content-rewrite"> </Optional>
  </ModulePrefs>

  <Content type="html" view="profile,home,canvas">
    <![CDATA[
            <script type="text/javascript" src="http://demo2.cirius.co.jp:3050/javascripts/jquery.uploadify-v1.6.2.mit/jquery-1.3.2.min.js"></script>
            <!-- script type="text/javascript" src="http://demo2.cirius.co.jp:3050/javascripts/opensocial-jquery-1.0.3/features/opensocial-jquery/opensocial-jquery.min.js"></script -->

            <script type="text/javascript" src="http://demo2.cirius.co.jp:3050/javascripts/jquery.uploadify-v1.6.2.mit/jquery.uploadify.js"></script>

            <script type="text/javascript">
        var Avatt = {};
        Avatt.Config = {
            debug: false,
            refresh: 3600,
            domain: 'http://demo2.cirius.co.jp:3050/logs/',
            disp: '__UP_disp__'
        };

        Avatt.Manager = function() {
            this.request = opensocial.newDataRequest();
            this.response = {};
            this.msg = new gadgets.MiniMessage('__MODULE_ID__');
            this.message = '';
        };

        Avatt.Manager.prototype = {
            //友達一覧を取得
            addGetFriendsRequest: function(){
                // 友達一覧を表すIdSpecを生成
                var _friends = {};
                _friends[opensocial.IdSpec.Field.USER_ID] = opensocial.IdSpec.PersonId.OWNER;
                _friends[opensocial.IdSpec.Field.GROUP_ID] = opensocial.IdSpec.GroupId.FRIENDS;
                var idspec = opensocial.newIdSpec(_friends);
                // 同じガジェットをインストールしている人を示すフィルタ
                var params = {};
                params[opensocial.DataRequest.PeopleRequestFields.MAX] = 1000;
                params[opensocial.DataRequest.PeopleRequestFields.FILTER] = opensocial.DataRequest.FilterType.HAS_APP;
                // オーナーの友達一覧を取得するリクエストを追加
                this.request.add(this.request.newFetchPeopleRequest(idspec, params), 'friends');
            },
            //オーナー情報を取得
            getOwner: function() {
                var results = {};
                var owner = this.response.get('owner');
                if (owner.hadError()) {
                    // 消せるミニメッセージでエラー表示
                    this.msg.createDismissibleMessage(owner.getErrorMessage());
                } else {
                    // オーナーのプロフィール情報を返す
                    return owner.getData();
                }
            },
            //友達の情報を取得
            getFriends: function() {
                var results = {};
                var friends = this.response.get('friends');
                if (friends.hadError()) {
                    // 消せるミニメッセージでエラー表示
                    this.msg.createDismissibleMessage(friends.getErrorMessage());
                } else {
                    results = friends.getData();
                }
                return results;
            },

            addGetOwnerRequest: function() {
                // オーナーのプロフィール情報を取得するリクエストを追加
                var params = {};
                params[opensocial.DataRequest.PeopleRequestFields.PROFILE_DETAILS] = [opensocial.Person.Field.URLS];
                this.request.add(this.request.newFetchPersonRequest(opensocial.IdSpec.PersonId.OWNER, params), 'owner');
            },
            addGetAppDataRequest: function(idspec, key) {
                this.request.add(this.request.newFetchPersonAppDataRequest(idspec, 'hatena_id'), key);
            },

            sendRequest :function(callback) {
                this.request.send(callback);
                this.message = this.msg.createDismissibleMessage('読み込み中...');
            },

            getAppData: function(key) {
                var results = {};
                var appdata = this.response.get(key);
                if (appdata && appdata.hadError()) {
                    // 消せるミニメッセージでエラー表示
                    this.msg.createDismissibleMessage(appdata.getErrorMessage());
                } else {

                    results = appdata.getData();
                }
                return results;
            }

        }

        /**
         * oauthリクエスト
         *
         */
        Avatt.Access = function() {
            this.url = "http://demo2.cirius.co.jp:3050/gadgets/signed";
            this.request = opensocial.newDataRequest();
            this.response = {};
            this.msg = new gadgets.MiniMessage('__MODULE_ID__');
            this.message = '';
        };
        Avatt.Access.prototype = {
            sendData: function(key) {
                var opt_params = {}
                opt_params[gadgets.io.RequestParameters.AUTHORIZATION] = gadgets.io.AuthorizationType.SIGNED;
                opt_params[gadgets.io.RequestParameters.CONTENT_TYPE]  = gadgets.io.ContentType.JSON;
                opt_params[gadgets.io.RequestParameters.METHOD]        = gadgets.io.MethodType.GET;
                this.url = this.url + "?" + gadgets.io.encodeValues({m:"げっと"});
                opt_params["REFRESH_INTERVAL"] = 60;

                gadgets.io.makeRequest(this.url, function(resp){
                    console.debug(resp.data)
                    console.debug(resp.errors)
                    console.debug(resp.text)
                }, opt_params)
            }
        }

        var mapObject;

        Avatt.Map = function(lat, lng) {
            this.count = 0;
            var self = this;

            this.setUrl = "http://jackal.sakura.ne.jp/tmap/";

            this.latlng = new google.maps.LatLng(lat, lng);
            this.mapOptions = {
                zoom: 8,
                center: this.latlng,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            mapObject = new google.maps.Map(document.getElementById("map_canvas"), this.mapOptions);
            map = mapObject;


            var contentString = '<div id="content">'+
                "<input type='button' id='setlatlng'  value='set lat lng'/>" + 
                '</div>';


            this.marker = new google.maps.Marker({
                position: this.latlng,
                map: mapObject,
                title:"Hello World!"
            });

            google.maps.event.addListener(mapObject,'click',function(event) {
                self.infowindow = new google.maps.InfoWindow({
                    content: contentString
                });
                if (self.marker) self.marker.set_position(event.latLng);
                self.infowindow.open(self.map, self.marker);
                self.addEvent(event.latLng);
            });

            google.maps.event.addListener(this.marker, 'click', function() {
                console.debug(self.marker);
            });
        };

        Avatt.Map.prototype = {
            initialize: function () {
            },
            handleError: function (a) {
                var d = document.getElementById("d");
                d.innerHTML = "<p> error: " + a.code + "</p>";
            },
            addEvent: function(latLng) {
                var self = this;
                var param  = self.setUrl + "?c=set&uid=" + "21888891" + "&pos=" + latLng.ee + "," + latLng.ge;
                $.ajax({
                    type: "GET",
                    url: param,
                    cache: false,
                    success: function(html){
                        alert("success");
                        //$("#results").append(html);
                    },
                    error: function(){
                        console.debug("error");
                    }
                });

//                 $('#setlatlng').click(function(event){

//                     console.debug(param);

//                 });

            }
        }




        Avatt.Data = function() {
            console.debug("data");
            this.getUrl = "http://jackal.sakura.ne.jp/tmap/";
        };
        Avatt.Data.prototype = {
            getData: function() {
                var self = this;
                var url = this.getUrl + "?c=get&uid=21888891&v=ijifd";
                console.debug(url);
                var params = {};
                gadgets.io.makeRequest(url, self.callback, params);

            },
            callback: function(data) {
                //console.debug(data);
                r = eval(data);
                //console.debug(r.data);
                r = eval(r.data);
                var latlng;
                $.each(r, function(i, item) {
                    console.debug(item.latlng);
                    latlng = new google.maps.LatLng(item.latlng);
                    latlng = new google.maps.LatLng(-25.363882,131.044922);
                    new google.maps.Marker({
                        position: latlng,
                        map: map,
                        title:"Hello World!"
                    });
                });

                //console.debug(data);
            }
        }


      </script>



            ]]>
  </Content>

  <Content view="home">
    <![CDATA[
        ホームビュー
    ]]>
  </Content>

  <Content type="html" view="canvas">
    <![CDATA[
      <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
      <script type="text/javascript">
            Avatt.init = function() {
                var mng = new Avatt.Manager();
                mng.addGetFriendsRequest();
                mng.addGetOwnerRequest();

                //自分のプロフィールを呼び出す設定
                var myself_params = {};
                myself_params[opensocial.IdSpec.Field.USER_ID] = opensocial.IdSpec.PersonId.OWNER;
                myself_params[opensocial.IdSpec.Field.GROUP_ID] = opensocial.IdSpec.GroupId.SELF;
                var myself = opensocial.newIdSpec(myself_params);
                mng.addGetAppDataRequest(myself, 'selfAppdata');


                var friends_params = {};
                friends_params[opensocial.IdSpec.Field.USER_ID] = opensocial.IdSpec.PersonId.OWNER;
                friends_params[opensocial.IdSpec.Field.GROUP_ID] = opensocial.IdSpec.GroupId.FRIENDS;
                var friends = opensocial.newIdSpec(friends_params);
                mng.addGetAppDataRequest(friends, 'friendsAppdata');


                var ownerid;
                mng.sendRequest((function() {
                    var _mng = mng;
                    return function(response) {
                        _mng.msg.dismissMessage(_mng.message);
                        if (response.hadError()) {
                            // 消せるミニメッセージでエラー表示
                            _mng.msg.createDismissibleMessage(response.getErrorMessage());
                        } else {
                            _mng.response = response;
                            // friends_data, selfAppdata, friendsAppdata
                            var myself =  _mng.getAppData('selfAppdata');
                            var friends = _mng.getFriends();
                            var appdata = _mng.getAppData('friendsAppdata');
                            var owner = _mng.getOwner();


                            ownewid = owner.getField(opensocial.Person.Field.ID);
                            var thumbnailUrl = owner.getField(opensocial.Person.Field.THUMBNAIL_URL);

                            friends.each(function (person) {
                                var nickname = person.getDisplayName();
                                //console.debug(nickname);
                            });

                            var ac = new Avatt.Access();
                            //ac.sendData();
                        }
                    }

                })());

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        var map = new Avatt.Map(position.coords.latitude, position.coords.longitude);
                        //map.drawMap(position.coords.latitude, position.coords.longitude);
//                        map.addEvent();
                        var data = new Avatt.Data();
                        data.getData();
                        $("#test").load("http://jackal.sakura.ne.jp/tmap/?c=get&uid=21888891");
                    },map.handleError);

                } else {  
                    alert("I'm sorry, but geolocation services are not supported by your browser.");  
                }

            }

        //         var friend = new Friend.Manager();
//         friend.getFriends('friends');
//         console.debug(friends);
//         //        Object request=Object response=Object msg=Object

//         //         var my = new Profile.Manager();
//         //         my.getProfile();
//         //         console.debug(my);


        
      </script>
      <style type="text/css">
            #left {
                float:left;
                width:300px;
                border:solid 1px #CCC;
            }
        #right {
                float:right;
                width:640px;
            }
        #right #map_canvas {
            }
        #pics img {
            width:80px;
            height:60px;
            padding:5px;
            border:solid 1px #CCC;
            margin:2px;
        }
      </style>
            <div id="test"></div>
        <div id="container">
          <div id="left">
            <ul>
              <li><a href="">my map</a></li>
              <li><a href="">all map</a></li>
            </ul>
            <div id="pics">
              <h3>pictures</h3>
              <img src="img"  alt="img"/>
              <img src="img"  alt="img"/>
              <img src="img"  alt="img"/>
              <img src="img"  alt="img"/>
              <img src="img"  alt="img"/>
              <p class="read-more"><a href="">display more pictures</a></p>
            </div>

            <div id="routes">
              <h3>set routes</h3>
            </div>
          </div>

          <div id="right">
            <div id="map_canvas" style="width:630px; height:290px"></div>
            <div id="d"></div>
            <button id="button">get</button>
          </div>


        </div> <!-- container END -->


      ]]>
  </Content>

  <Content type="html" view="profile">
    <![CDATA[
            <script type="text/javascript">

            </script>
            ]]>
    <div>profile</div>
  </Content>

  <Content type="html" view="home,canvas,profile">
    <![CDATA[
            <script type="text/javascript">
              //console.log(Location.Manager);
              // onload ハンドラを登録します。このハンドラは、ガジェットの読み込み時に実行される関数です。 
            gadgets.util.registerOnLoadHandler(Avatt.init);
            </script>
            ]]>

  </Content>
</Module>
