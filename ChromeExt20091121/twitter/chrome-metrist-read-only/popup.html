<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <link href="assets/css/reset-min.css" rel="stylesheet" type="text/css" /> 
        <link href="assets/css/popup.css" rel="stylesheet" type="text/css" /> 
    </head>
    <body>
        <div id="page">
            <div id="content" style="visibility: hidden;">
                <div>
                    <ul class="tweets" id="metrist:friends" ref="friends">
                        <!--
                        <li id="234" screen_name="feelinglucky" tweets_text="item.text">
                            <h4 class="nick"><a href="#">明城</a></h4>
                            <p class="time">12h</p>
                            <p class="avatar"><img src="assets/images/avatar.png" /></p>
                            <p class="message">RT <a href="#">@feelinglucky</a>: 腾讯 TM 测试版的“锁定”功能非常棒</p>
                            <p class="act"><a href="#" act="Retweet">Retweet</a><a href="#" act="Reply">Reply</a></p>
                        </li>
                        <li class="reply">
                            <h4 class="nick"><a href="#">明城</a></h4>
                            <p class="time">12h</p>
                            <p class="avatar"><img src="assets/images/avatar.png" /></p>
                            <p class="message">RT <a href="#">@feelinglucky</a>: 腾讯 TM 测试版的“锁定”功能非常棒</p>
                            <p class="act"><a href="#" act="Retweet">Retweet</a><a href="#" act="Reply">Reply</a></p>
                        </li>
                        <li class="direct">
                            <h4 class="nick"><a href="#">明城</a></h4>
                            <p class="time">12h</p>
                            <p class="avatar"><img src="assets/images/avatar.png" /></p>
                            <p class="message">RT <a href="#">@feelinglucky</a>: 腾讯 TM 测试版的“锁定”功能非常棒</p>
                            <p class="act"><a href="#" act="Retweet">Retweet</a><a href="#" act="Reply">Reply</a></p>
                        </li>
                        <li class="me">
                            <h4 class="nick"><a href="#">明城</a></h4>
                            <p class="time">12h</p>
                            <p class="avatar"><img src="assets/images/avatar.png" /></p>
                            <p class="message">RT <a href="#">@feelinglucky</a>: 腾讯 TM 测试版的“锁定”功能非常棒</p>
                            <p class="act"><a href="#" act="Retweet">Retweet</a><a href="#" act="Reply">Reply</a></p>
                        </li>
                        -->
                    </ul>
                    <ul class="tweets" id="metrist:replies" ref="replies">
                        <!--
                        <li class="reply">
                            <h4 class="nick"><a href="#">明城</a></h4>
                            <p class="time">12h</p>
                            <p class="avatar"><img src="assets/images/avatar.png" /></p>
                            <p class="message">RT <a href="#">@feelinglucky</a>: 腾讯 TM 测试版的“锁定”功能非常棒</p>
                            <p class="act"><a href="#" act="Retweet">Retweet</a><a href="#" act="Reply">Reply</a></p>
                        </li>
                        -->
                    </ul>

                    <ul class="tweets" id="metrist:directs" ref="directs">
                        <!--
                        <li class="direct">
                            <h4 class="nick"><a href="#">明城</a></h4>
                            <p class="time">12h</p>
                            <p class="avatar"><img src="assets/images/avatar.png" /></p>
                            <p class="message">RT <a href="#">@feelinglucky</a>: 腾讯 TM 测试版的“锁定”功能非常棒</p>
                            <p class="act"><a href="#" act="Retweet">Retweet</a><a href="#" act="Reply">Reply</a></p>
                        </li>
                        -->
                    </ul>
                    <ul class="console" id="metrist:console">
                        <li class="error">this is error!</li>
                        <li class="warn">this is warn</li>
                        <li class="log">this is log</li>
                    </ul>
                </div>
            </div>
            <div id="form">
                <form action="#" method="post" id="metrist:form">
                    <div id="tweet">
                        <textarea id="form:input"></textarea>
                        <span id="form:status">140</span>
                        <div class="action">
                        <button title="Send Tweets" type="button" id="submit">update</button>
                        <button title="Config Metrist" type="button" id="config">config</button>
                        </div>
                    </div>
                </form>
            </div>
            <ul id="channel">
                <li class="friends selected" title="Timeline">Friends</li>
                <li class="replies" title="Mention">Mention</li>
                <li class="directs" title="Message">Message</li>
                <li class="console" id="Console" title="Console">Console</li>
            </ul>
            <p id="status">　</p><a id="refresh" title="Refresh">Refresh</a>
        </div>
        <div id="loading" class="loading-min hidden"></div>
        <div id="notice" class="hidden"><span></span></div>
        <script type="text/javascript" src="assets/yui-special/yahoo.js"></script>
        <script type="text/javascript" src="assets/yui-special/dom.js"></script>
        <script type="text/javascript" src="assets/yui-special/event.js"></script>
        <script type="text/javascript" src="assets/yui-special/animation.js"></script>
        <script type="text/javascript" src="assets/yui-special/connection_core.js"></script>
        <script type="text/javascript" src="assets/scripts/common.js"></script>
        <script type="text/javascript" src="assets/scripts/ui.js"></script>
        <script type="text/javascript">
            (function() {
                var Util = YAHOO.util, Dom = Util.Dom, Event = Util.Event, Lang = YAHOO.lang;

                if (getConf('conf_use_console', 'yes') == 'yes') {
                    window.console = UI.HTMLConsole;
                } else {
                    Dom.addClass('metrist:console', 'hidden');
                    Dom.addClass('Console', 'hidden');
                }

                var Tweets = (function() {
                    var backgroundPage = chrome.extension.getBackgroundPage();
                    var Server = backgroundPage.Server;
                    return {
                        update: function() {
                            UI.Loading.showMini();
                            backgroundPage.Twitter.update(UI.InputArea.getValue(), {
                                onSuccess: function(o) {
                                    UI.InputArea.setValue('', true);
                                    setStatus('last_input', '');
                                    UI.InputArea.check();
                                    UI.Loading.hideMini(function() {
                                        var t = backgroundPage.Tweets, channel = 'friends', tmp = [];
                                        tmp.push(JSON.parse(o.responseText));
                                        t.addToList(channel, tmp);
                                        UI.Rebuild.channel(channel, t.getList(channel));
                                        console.info('Update tweets successfully');
                                        UI.Notice.show('Update tweets successfully');
                                    });
                                },
                                onError: function() {
                                    UI.Loading.hide();
                                    UI.Notice.show('Update tweets error');
                                    console.info('Update tweets error')
                                }
                            });
                        },

                        getData: function(name) {
                            return backgroundPage.Tweets.getList(name);
                        },

                        isRequesting: function() {
                            return Server.status().requesting;
                        },

                        clearUnreadNum: function() {
                            Lang.later(2000, window, function() {
                                backgroundPage.Tweets.clearUnreadNum();
                                setBadgeText('');
                            });
                        },
                        Server: Server
                    };
                })();


                var TweetsTextAreaEl = Dom.get('form:input'), TweetsUpdateBtnEl = Dom.get('submit'),
                    TweetsUpdateFormEl = Dom.get('metrist:form');

                Event.on(TweetsUpdateFormEl, 'submit', function(e) {
                    Event.stopEvent(e);
                    return false;
                });

                Event.on(TweetsUpdateBtnEl, 'click', function(e) {
                    var e = Event.getEvent(e), tweets_text = UI.InputArea.getValue();
                    Event.stopEvent(e);
                    setStatus('last_input', tweets_text);
                    if (tweets_text.length) Tweets.update();
                    /*
                    if (UI.InputArea.check()) {
                        Tweets.update();
                    }
                    */
                });

                Event.on(TweetsTextAreaEl, 'keydown', function(e) {
                    var e = Event.getEvent(e), tweets_text = UI.InputArea.getValue();
                    setStatus('last_input', tweets_text);
                    if (Event.getCharCode(e) == 13 /* && e.ctrlKey */) {
                        Event.stopEvent(e);
                        if (tweets_text.length) Tweets.update();
                    }
                });

                // 切换时候的代码
                UI.Channel.setSwitchToCall(function() {
                    var current = UI.Channel.getCurrentIdx(), 
                        container = UI.Channel.containers[current];
                    var loaded = Dom.getAttribute(container, 'loaded'),
                        ref = Dom.getAttribute(container, 'ref');

                    setStatus('last_index', current);
                    if (getConf('conf_use_console', 'yes') == 'yes') {
                        if (container.getAttribute('id') == 'metrist:console') {
                            UI.HTMLConsole.refresh();
                            //return;
                        }
                    }

                    if (loaded != 'loaded' && ref) {
                        Dom.setAttribute(container, 'loaded', 'loaded');
                        try {
                            UI.Rebuild.channel(ref, Tweets.getData(ref));
                        } catch (e) {
                            console.error('UI.Rebuild.channel: build ['+ ref +'] error');
                        }
                    }
                });

                var defaultIdx = getStatus('last_index') || 0;
                if ((getConf('conf_use_console', 'yes') != 'yes') && defaultIdx > 2) {
                    defaultIdx = 0;
                }

                Dom.setStyle('content', 'visibility', 'hidden');
                UI.Loading.show(function() {
                    var foo = Lang.later(50, window, function() {
                        if (!Tweets.isRequesting()) {
                            foo.cancel();
                            UI.Loading.hide(function() {
                                Dom.setStyle('content', 'visibility', '');
                                Tweets.clearUnreadNum(); // clear unread

                                // 及时更新输入框状态以及数据
                                Lang.later(500, window, function() {
                                    UI.InputArea.check();
                                    var inputValue = UI.InputArea.getValue();
                                    /*
                                    if (!inputValue) {
                                        UI.Status.setValue('Ready!');
                                    }
                                    */
                                    setStatus('last_input', inputValue);
                                }, null, true); 

                                Dom.get('refresh').setAttribute('title', 'Request ' +
                                    relativeTime(localStorage['status_last_request_tweets']).toLowerCase());

                                UI.Channel.switchTo(defaultIdx, false); // Hallelujah!!!
                            }, false);
                        }
                    }, null, true);
                });

                UI.InputArea.setValue(getStatus('last_input'));

                // 刷新事件
                var foo = null, refreshEvent = function(e) {
                    if (!Lang.isUndefined(e)) { Event.stopEvent(e); }
                    UI.Loading.show(function() {
                        if (foo){ foo.cancel(); };
                        Tweets.Server.restart();
                        foo = Lang.later(50, window, function() {
                            if (!Tweets.isRequesting()) {
                                foo.cancel();
                                UI.Loading.hide(function(){
                                    UI.Rebuild.all([
                                        { name: 'friends', data: Tweets.getData('friends')},
                                        { name: 'replies', data: Tweets.getData('replies')},
                                        { name: 'directs', data: Tweets.getData('directs')}
                                    ]);
                                    Dom.get('refresh').setAttribute('title', 'Request ' +
                                        relativeTime(localStorage['status_last_request_tweets']).toLowerCase());
                                });
                            };
                        }, null, true);
                    });
                };
                Event.on('refresh', 'click', refreshEvent);
                var minutes = parseInt(getConf('conf_per_request_time', 10), 10);
                Lang.later(minutes * 60 * 1000, UI, refreshEvent, null, true);

                Event.on('config', 'click', function(e) {
                    Event.stopEvent(e);
                    chrome.tabs.create({url: 'options.html'});
                });

                // 界面点击事件
                Event.on('content', 'click', function(e) {
                    var target = Event.getTarget(e);
                    if (target.nodeName.toLowerCase() == 'a') {
                        Event.stopEvent(e);
                        var act = (Dom.getAttribute(target, 'act') || '').toLowerCase();
                        if (act) {
                            switch (act) {
                                case 'reply': 
                                    var ancestor = Dom.getAncestorByTagName(target, 'li');
                                    if (ancestor) {
                                        var isDirect = !!Dom.hasClass(ancestor, 'direct'),
                                            prefix = isDirect ? 'd ' : '@',
                                            screen_name = Dom.getAttribute(ancestor, 'screen_name'),
                                            value = prefix + screen_name + ' ';
                                        var inputAreaEmpty = !!UI.InputArea.getValue();

                                        if (!isDirect && inputAreaEmpty) {
                                            value = UI.InputArea.getValue() + ' ' + value;
                                        }
                                        //UI.Status.setValue((isDirect ? 'Direct' : 'Reply') + ' to ' + screen_name);
                                        UI.InputArea.setValue(value, true, false);
                                        UI.InputArea.check();
                                        UI.InputArea.focus();
                                    }
                                break;

                                case 'retweet':
                                    var ancestor = Dom.getAncestorByTagName(target, 'li');
                                    if (ancestor) {
                                        var screen_name = Dom.getAttribute(ancestor, 'screen_name')
                                        var value = 'RT @' + screen_name + ': '
                                                + Dom.getAttribute(ancestor, 'tweets_text');
                                        UI.InputArea.setValue(value, true, false);
                                        UI.InputArea.check();
                                        UI.InputArea.focus();
                                        //UI.Status.setValue('RT from @' + screen_name);
                                    }
                                break;

                                default: return;
                            }
                         } else {
                            var href = Dom.getAttribute(target, 'href') || '';
                            if (/^(http|https):\/\//.test(href)) {
                                chrome.tabs.create({url: href});
                            }
                         }
                    }
                });
             })();
        </script>
    </body>
</html>
