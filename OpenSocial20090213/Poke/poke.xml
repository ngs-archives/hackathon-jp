<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs title="poke">
    <Require feature="opensocial-0.8" />
  </ModulePrefs>
  <Content type="html" >
    <![CDATA[
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.2.6/jquery.js"></script>
    <script type="text/javascript">
      myAttrs = {};

      masterAttrs = { item1: "善", item2: "悩", item3: "愛", item4: "H" };

      function debug( obj ) {
        if ( window.console ) {
          console.debug( obj );
        }
      }

      // TODO 今見てるのがオーナーでかつ最初なら、初期化データ作成
      function initMyAttrs() {
debug("initMyAttrs");
          for (i in masterAttrs) {
              myAttrs[i] = Math.floor(Math.random() * 30);
          }
          var json = gadgets.json.stringify(myAttrs);
          debug(json);

          var req = opensocial.newDataRequest();
          req.add(req.newUpdatePersonAppDataRequest(opensocial.IdSpec.PersonId.VIEWER, 'attrs', json));
          req.add(req.newUpdatePersonAppDataRequest(opensocial.IdSpec.PersonId.VIEWER, 'latestAttrs', json));
          req.send();
      }

      function getMyAttrs(divId) {
debug("getMyAttrs");
          var idSpec = opensocial.newIdSpec({"userId": opensocial.IdSpec.PersonId.VIEWER});

          var req = opensocial.newDataRequest();

          req.add(req.newFetchPersonRequest(opensocial.IdSpec.PersonId.VIEWER), 'owner');
          req.add(req.newFetchPersonAppDataRequest(idSpec, 'attrs'), "data");
          req.send(function(data) {
               debug("callback");
               var attrs = data.get("data").getData();
               var owner = data.get("owner").getData();
               debug( myAttrs );

               debug("owner_id" + owner.getId());

               if (!attrs[owner.getId()] ) {
                 $("#" + divId).html('no data');
                 return;
               }
               var jsonStr = attrs[owner.getId()]['attrs'];
               debug("jsonStr");
               debug(jsonStr);

               var json = gadgets.json.parse(gadgets.util.unescapeString(jsonStr));
               debug("json");
               debug(json);


               var html = ['<dl>'];
               for ( itemkey in json ) {
                 html.push('<dt>' + masterAttrs[itemkey] + '</dt>');
                 html.push('<dd>' + json[itemkey] + '</dd>');
                 }
               html.push('</dl>');

               $("#" + divId).html(html.join(''));
          });
      }

      function updateLatest(divId) {
        
      }

      $(function(){
        debug("init");
        getMyAttrs('main');
      });
    </script>
    <button type="button" onclick="initMyAttrs();">Init!</button>
    <button type="button" onclick="getMyAttrs('main');">Refresh!</button>
    <button type="button" onclick="updateLatest('latest')">Lastest!</button>
    <div id="main">あいうえお</div>

    <div id="latest">最新状態</div>
    ]]>
  </Content>
  <!--
  <Content view="profile" type="html" >
    <![CDATA[
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.2.6/jquery.js"></script>
    <script type="text/javascript">
      $(function(){


      });
    </script>
    ]]>
  </Content>
  <Content view="preview" type="html" >
    <![CDATA[
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.2.6/jquery.js"></script>
    <script type="text/javascript">
      $(function(){


      });
    </script>
    ]]>
  </Content>
  <Content view="canvas" type="html" >
    <![CDATA[
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.2.6/jquery.js"></script>
    <script type="text/javascript">
      $(function(){


      });
    </script>
    ]]>
  </Content>
  -->
</Module>
