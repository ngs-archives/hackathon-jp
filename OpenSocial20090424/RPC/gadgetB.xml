<?xml version="1.0" encoding="UTF-8"?>
<Module>
<ModulePrefs
  title="[RPC] goo×ホットペッパー (開発中)"
  description="[RPC] goo×ホットペッパー (開発中)"
>
<Require feature="opensocial-0.8" />
<Require feature="pubsub" />
</ModulePrefs>
<Content type="html" view="home,profile,canvas"><![CDATA[
<script type="text/javascript" src="http://d1lzci7p8hi5b7.cloudfront.net/opensocial-jquery.min.js"></script>
<script type="text/javascript">
jQuery(function($) {

  // byAddress
  function byAddress(address) {

    var url = 'http://webservice.recruit.co.jp/hotpepper/gourmet/v1/';
    var data = { 
      key: 'b23f89f420f6b18b', format: 'json', address: address
    };

    $.getJSON(url, data, function(data) {

      var shops = $('#shops')
        .empty();

      $.each(data.results.shop, function(i, shop) {

        var s = $('<img/>')
          .attr('alt', shop.name)
          .attr('src', shop.photo.pc.s)
          .click(function() {
            $.pub('RPC', { lat: parseFloat(shop.lat), lng: parseFloat(shop.lng) });
          });
          
        $('<div class="shop"/>')
          .append(s)
          .appendTo(shops);
      });

    });
  };

  // byLatLng
  function byLatLng(lat, lng) {

    var url = 'http://webservice.recruit.co.jp/hotpepper/gourmet/v1/';
    var data = { 
      key: 'b23f89f420f6b18b', format: 'json', lat: lat, lng: lng
    };

    $.getJSON(url, data, function(data) {

      var shops = $('#shops')
        .empty();

      $.each(data.results.shop, function(i, shop) {

        var s = $('<img/>')
          .attr('alt', shop.name)
          .attr('src', shop.photo.pc.s)
          .click(function() {
            $.pub('RPC', { lat: parseFloat(shop.lat), lng: parseFloat(shop.lng) });
          });
          
        $('<div class="shop"/>')
          .append(s)
          .appendTo(shops);
      });

    });
  };

  $.sub('RPC', function(sender, message) {
    byLatLng(message.lat, message.lng);
  });

  $('#form').submit(function() {
    byAddress(this.address.value);
    return false;
  });

});
</script>
<style type="text/css">
<!--

body {
  font-family: Verdana,Arial,Helvetica,sans-serif;
  font-size: .8em;
  margin: 5px;
}

#shops div.shop {
/*border: 1px solid black;*/
  text-align: center;
  width: 64px;
  height: 64px;
  float: left;
}

#shops div.shop img {
  cursor: pointer;
}

-->
</style>
<form id="form">
<input type="text" name="address" value="新橋" />
<input type="submit" value="検索" />
</form>
<div id="shops">読み込み中 ...</div>

]]></Content>
</Module>
