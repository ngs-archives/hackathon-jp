<?xml version="1.0" encoding="UTF-8"?>
<Module>
	<ModulePrefs
		title="チュートリアル"
		description="desc">
        <Require feature="opensocial-0.8" />
        <Require feature="dynamic-height" />
	</ModulePrefs>
	<Content type="html" view="home,profile,canvas"><![CDATA[<script type="text/javascript">
if (typeof console == 'undefined') {
	this.console = {
		// debug:alert
		debug:function(){}
		, error:alert
	};
}

function FormatUrl(url, text)
{
	if (!text) text = url;
	var url = url.replace(/"/g, '&quot;').replace('<', "&lt;");
	return '<a href="' + url + '">' + text + '</a>';
}

function GetSupportedFields()
{
	var env = opensocial.getEnvironment();
	
	var objectType = opensocial.Environment.ObjectType.PERSON;
	
	var fields = [];
	for(fieldName in opensocial.Person.Field)
	{
		if (env.supportsField(objectType, opensocial.Person.Field[fieldName]))
		{
			// alert(fieldName);
			fields.push(opensocial.Person.Field[fieldName]);
		}
	}
	
	return fields;
}

function LazyAdjustHeight()
{
	setTimeout(function (){
		if (typeof gadgets != 'undefined')
			gadgets.window.adjustHeight();
	}, 100);
}
 

function GeneratePersonInfo(person) {
	var html = '';
	
		console.debug(person);
		/* @var person Person */
		html += '<div><b>' + person.getDisplayName() + '</b></div>';
		html += '<dl>';
		html += '<dt>id</dt><dd>' + person.getId() + '</dd>';
		
		html += '<dt>isOwner</dt><dd>' + person.isOwner() + '</dd>';
		html += '<dt>isViewer</dt><dd>' + person.isViewer() + '</dd>';
		
		for(i in opensocial.Person.Field){
			var env = opensocial.getEnvironment();
			var objectType = opensocial.Environment.ObjectType.PERSON;
			if (!env.supportsField(objectType, opensocial.Person.Field[i]))
				continue;
		
			var info = person.getField(opensocial.Person.Field[i]);
			if (typeof info == 'undefined')
				continue;
			
			if (i == "THUMBNAIL_URL")
				info = "<img src='" + info + "' />";
			else if (info['getDisplayValue'])
				info = info.getDisplayValue();
			else if (i == 'NAME')
				info = info.getField(opensocial.Name.Field.UNSTRUCTURED);
			else if (i == 'URLS')
			{
				var urlstr = ''; 
				for (var j = 0; j < i.length; ++j)
				{
					var url = info[j];
					if (!url) continue;
					urlstr +=
						FormatUrl(
							url.getField(opensocial.Url.Field.ADDRESS), 
							url.getField(opensocial.Url.Field.LINK_TEXT)
						)
						+ ' (' + url.getField(opensocial.Url.Field.TYPE) + ')<br />';
				}
				info = urlstr;
			}
			else if (typeof info != 'string')
			{
				console.debug(i);
				console.debug(info);
			}
			
			if (!info) info = '';
			
			// XXX
			if (info['match'] && info.match(/^http\:/))
				info = FormatUrl(info);
			
			html += '<dt>' + i + '</dt><dd>' + info + '</dd>';
		}
		html += '</dl>';
		
		document.getElementById('result_data').innerHTML += html;
		
} // GeneratePersonInfo


function Tutorial_fetchOwner(){
	try{
		var req = opensocial.newDataRequest();
		
		var params = {}; 
		params[opensocial.DataRequest.PeopleRequestFields.PROFILE_DETAILS]
			= GetSupportedFields();
			
		req.add(req.newFetchPersonRequest(opensocial.IdSpec.PersonId.OWNER, params), "get_owner");
		req.send(function(dataResponse) {
			var owner = dataResponse.get('get_owner').getData();
			/* @var owner_friends Collection<Person> */ 
			
			console.debug(owner);
			var html = '';
			if (owner)
			{
				html += owner.getDisplayName();
				document.getElementById('result_data').innerHTML += html;
				GeneratePersonInfo(owner);
			}
			else
			{
				html += '取得できませんでした';
			}
			
			
		});
	} catch(e) {
		console.error(e.message);
	}
}

function Tutorial_env(){
	try {
		var env = opensocial.getEnvironment();
		var html = '';
		html += 'domain: ' + env.getDomain() + '<br />';
		document.getElementById('result_data').innerHTML = html;
		LazyAdjustHeight();
	}catch(e){
		console.error(e.message);
	}
}

function postActivity() {
	var id = 'result_data';
	var params = {};
	params[opensocial.Activity.Field.TITLE] = document.getElementById('title').value;
	var activity = opensocial.newActivity(params);
	opensocial.requestCreateActivity(
		activity, opensocial.CreateActivityPriority.HIGH, function(response) {
		if (response.hadError()) {
			document.getElementById(id).innerHTML = response.getErrorCode();
		} else {
			document.getElementById(id).innerHTML = 'アクティビティーを送信しました。';
		}
		gadgets.window.adjustHeight();
		}
	);
}

</script>
<style type="text/css">
td { border: solid 1px; vertical-align: top; }
</style>

<table><tr><td style="width:500px;">

<div>
	<button onclick="Tutorial_env();">環境情報</button>
	<button onclick='Tutorial_fetchOwner();'>オーナー情報</button>
	<input type='text' id='title' /><button onclick='postActivity();'>アクティビティー送信!</button>
</div>

<!-- Sharing data with friends -->
<!--
<div>
  <input type='text' id='content' />
  <button onclick='shareData();'>データ保存</button>
  <button onclick='fetchFriendData();'>友人のデータを取得</button>
  <div id='result_appdata'></div>
  <ul id='contents'></ul>
</div>
-->
	
<!-- counter -->
<div>
  <input type='text' id='counter' value="0" />
  <button onclick='CouterInc();'>カウントアップ!</button>
  <button onclick='CouterReset();'>リセット</button>
  <div id='result_appdata'></div>
  <ul id='contents'></ul>
</div>
	
<td id="result_data" style="width: 930px; height: 200px; overflow:scroll;">
</td>
</tr></table>

	</div>]]></Content>
</Module>
