<?xml version="1.0" encoding="UTF-8"?>
<Module>
	<ModulePrefs title="PersonList"
				 description="こんにちは，世界"
					 author_email="iron.nori@gmail.com">
					 <Require feature="opensocial-0.8"/>
	</ModulePrefs>
	<Content type="html" view="home"><![CDATA[
		PersonList
		
	]]></Content>
	<Content type="html" view="profile"><![CDATA[
		PersonList
	]]></Content>
	<Content type="html" view="canvas"><![CDATA[
		<link style="stylesheet" type="text/css" href="http://hackathon-jp.googlecode.com/svn/trunk/OpenSocial20090424/Tutorial/ueno/style.css"/>
		<script type="text/javascript">
			gadgets.util.registerOnLoadHandler(request);
			function request(){
				var idspec	= opensocial.newIdSpec({"userId":"OWNER","groupId":"FRIENDS"});
				var req 	= opensocial.newDataRequest();
				req.add(req.newFetchPersonRequest("OWNER"),"get_owner");
				
				var params = {}

				params[opensocial.DataRequest.PeopleRequestFields.MAX] = 200;

				var allFields = [];
				for(field in opensocial.Person.Field){
					allFields.push(opensocial.Person.Field[field]);
				}
				params[opensocial.DataRequest.PeopleRequestFields.PROFIEL_DITAILS] = allFields;

				req.add(req.newFetchPeopleRequest(idspec,params),"get_friends");
				req.send(response);
			}

			function response(dataResponse){
				var owner	= dataResponse.get("get_owner").getData();
				var friends	= dataResponse.get("get_friends").getData();

				var html = "";
				html = "<ul style='display:inline'>";
				html += "</ul>";
				html += owner.getDisplayName();
				html += "友達" + friends.size() +"人"
				html += "<table>";
				
			
				
				html += "<tr>";
				for(i in opensocial.Person.Field){
					html += "<th>";
					html += i;
					html += "</th>";
				}
				html += "</tr>";
				
				friends.each(function(person){
					html += "<tr>";
					for(i in opensocial.Person.Field){
						html+= "<td>";
						if(i == "THUMBNAIL_URL"){
							html+="<img src='"+person.getField(opensocial.Person.Field[i]) +"'></img>";
						}else{
							html+= person.getField(opensocial.Person.Field[i]);
						}
						html+= "</td>";
					}
					html += "</tr>";
				});
				html += "\n</table>";
				document.getElementById("message").innerHTML = html;
			};
			
			function populateMyAppData(){
					var req = opensocial.newDataRequest();
					var data1 = Math.random() * 5;
					var data2 = Math.random() * 100;
					var data3 = new Date().getTime();
					
					htmlout += "AppField1 <- " + data1 +"<br/>";
					req.add(req.newUpdatePersonAppDataRequest("VIEWER","AppField1",data1));
					htmlout += "AppField2 <- " + data2 +"<br/>";
					req.add(req.newUpdatePersonAppDataRequest("VIEWER","AppField2",data2));
					htmlout += "AppField3 <- " + data3 +"<br/>";
					req.add(req.newUpdatePersonAppDataRequest("VIEWER","AppField3",data3));
					req.send(handlePopulateMyAppData);
					
			}

			function handlePopulateMyAppData(data){
				if(data.hadError()){
					htmlout += data.getErrorMessage();
				}
				requestMyData();
			}

			function requestMyData(){
				var req = opensocial.newDataRequest();
				var fields = ["AppField1","AppField2","AppField3"];

				req.add(req.newFetchPersonRequest(opensocial.IdSpec.PersonId.VIEWER),"viewer");
				req.add(req.newFetchPersonAppDataRequest("VIEWER",fields),"viewer_data");
				req.send(handleRequestMyData);
			}

			function handleRequestMyData(data){
				var mydata = data.get("viewer_data");
				var viewer = data.get("viewer");
				me = viewer.getData();

				if(mydata.hadError()){
					htmlout += data.getErrorMessage();
					return;
				}
				doSomethingWithMyData(mydata.getData());
			}

			function doSomethingWithMyData(data){
				var mydata = data[me.getId()];
				var div = document.getElementById('content_div');
				htmlout += "AppField1 ->" + mydata["AppField1"] +"<br/>";
				htmlout += "AppField2 ->" + mydata["AppField2"] +"<br/>";
				htmlout += "AppField3 ->" + mydata["AppField3"] +"<br/>";
				div.innerHTML = htmlout;
			}

		</script>
		<div id="message">
		</div>
	]]></Content>
</Module>
