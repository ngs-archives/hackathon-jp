<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs title="友達情報取得アプリ">
    <Require feature="opensocial-0.8" />
  </ModulePrefs>
  <Content type="html">
    <![CDATA[
    <script type="text/javascript">
    
	var html = "";  
	function loadFriends() {
		var req = opensocial.newDataRequest();
		req.add(req.newFetchPersonRequest(opensocial.IdSpec.PersonId.VIEWER), 'viewer');
		var viewerFriends = opensocial.newIdSpec({ "userId" : "VIEWER", "groupId" : "FRIENDS" });
		var opt_params = {};
		opt_params[opensocial.DataRequest.PeopleRequestFields.MAX] = 100;
		req.add(req.newFetchPeopleRequest(viewerFriends, opt_params), 'viewerFriends');
		req.send(onLoadFriends);
	}

	function onLoadFriends(data) {
	var viewer = data.get('viewer').getData();
	var viewerFriends = data.get('viewerFriends').getData();
	html += '<b>MyAlbum</b><br>';

	fetchMyAlbums();
	html += '<hr>';

	viewerFriends.each(function(person) {
	if (person.getId()) {
	fetchAlbums(person.getId(), person.getDisplayName());

	}
	});

	}

	function init() {
		loadFriends();
	}


	function fetchMyAlbums(userId) {
		var idspec_params = {};
		idspec_params[opensocial.IdSpec.Field.USER_ID] = userId;
		var idSpec = opensocial.newIdSpec({'userId':'OWNER', 'groupId':'SELF'});
		var opt_params = { };
		opt_params['albumId'] = [];
		var req = opensocial.newDataRequest();
		req.add(req.newFetchAlbumsRequest(idSpec, opt_params), "album");

		var func = function (data) { processAlbums(data, 'MyAlbum'); };
		
		req.send(func);

	};

	function fetchAlbums(userId, pname) {
		var idspec_params = {};
		idspec_params[opensocial.IdSpec.Field.USER_ID] = userId;
		//var idSpec = opensocial.newIdSpec({'userId':userId, 'groupId':'SELF'});
		var idSpec = opensocial.newIdSpec(idspec_params);
		var opt_params = { };
		opt_params['albumId'] = [];
		var req = opensocial.newDataRequest();
		req.add(req.newFetchAlbumsRequest(idSpec, opt_params), "album");
		
		var func = function (data) { processAlbums(data, pname); };
		
		req.send(func);

	};
 
	function processAlbums(data, pname) {
		var albumz = data.get("album").getData();
		albumz.each(function(album) {
		html += pname + "<br>";
		html += '<img src="' + album.getThumbnailUrl() + '">';
		});

		document.body.innerHTML += html;
	};


	gadgets.util.registerOnLoadHandler(init);
	
	
	

        // Fetches all photos from the album with the passed ID
        function fetchPhotos(albumId) {
          var req = opensocial.newDataRequest();
          var idspec = opensocial.newIdSpec({'userId':'VIEWER', 'groupId':'SELF'});

          req.add(req.newFetchMediaItemsRequest(idspec, albumId), 'albumPhotos');
          req.send(fetchPhotosHandler);
        };

        // Callback function, executed when orkut finishes fetching the
        // requested media items
        function fetchPhotosHandler(resp) {
          document.getElementById('photoGrid').innerHTML = '';
          var albumPhotosResp = resp.get('albumPhotos');

          if (!albumPhotosResp.hadError()) {
            var albumPhotos = albumPhotosResp.getData();

            // Add each photo's thumbnail to the photo grid
            albumPhotos.each(
              function(photo) {
                addToPhotoGrid(photo);
              }
            );
          }
        };

        // Adds the passed photo's thumbnail to the photo grid
        function addToPhotoGrid(photo) {
          document.getElementById('photoGrid').innerHTML +=
            '<img src="' + photo.getThumbnailUrl()+'"/>';
        };

        // Execute fetchAlbums function when gadget loads
        gadgets.util.registerOnLoadHandler(fetchAlbums);
      </script>

      <!-- Table to display album thumbnail and metadata -->
      <table id="albumTable" cellspacing="5"></table>

      <h2>Photos from selected album:</h2>

      <!-- Styled div to display photos from selected album -->
      <div id="photoGrid"></div>
	
	
	
    </script>
    ]]>
  </Content>
</Module>
