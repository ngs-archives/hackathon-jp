<?xml version="1.0" encoding="UTF-8"?>
<Module>
<ModulePrefs title="しりとり(日本語版)">
<Require feature="opensocial-0.7"/>
</ModulePrefs>
<Content type="html">
<![CDATA[
<script type="text/javascript" src="http://hackathon-jp.googlecode.com/svn/trunk/OpenSocial20090221/Wall/capping/jquery-1.2.6.js"></script>
<script type="text/javascript">
/**
 *
 *
 */
function init() {
    loadFriends();

    $("#btn_submit").bind("click", function(){
        if(validateData()) {
            sendTextToAFriend();
        }
    });
}

/**
 *
 *
 */
function loadFriends() {
    var req = opensocial.newDataRequest();
    req.add(req.newFetchPersonRequest("OWNER"), "owner");
    req.add(req.newFetchPeopleRequest("OWNER_FRIENDS"), "owner_friends");
    req.add(req.newFetchPersonAppDataRequest("OWNER", "cap"), "owner_cap");
    req.add(req.newFetchPersonAppDataRequest("OWNER_FRIENDS", "cap"), "owner_friends_cap");
    req.send(handleLoadFriends);
}

/**
 *
 *
 */
function handleLoadFriends(data) {
    if(data.hadError()) {
        alert('error');
        alert(data.getErrorMessage());
        return;
    }
    onLoadFriends(data);
}

/**
 *
 *
 */
function onLoadFriends(data) {
    var owner = data.get("owner").getData();
    var ownerFriends = data.get("owner_friends").getData();
    var owner_cap = data.get("owner_cap").getData();
    var owner_friends_cap = data.get("owner_friends_cap").getData();

    alert(owner_cap);
    alert(owner_friends_cap);
    
    var html = new Array();
    html.push("<select id='person'>");
    ownerFriends.each(function(person){
        html.push("<option value='" + person.getId() + "'>" + person.getDisplayName() + "</option>");
    });
    html.push("</select>");
    $("#select").html(html.join(""));
}

/**
 *
 *
 */
function sendTextToAFriend() {
    var cappingText = $("#capping").val();
    var personId = $("#person").val();
    alert(personId);

    var sendText = {};
    var cap_data = {};
    cap_data["cap"] = cappingText;
    cap_data["flg"] = 1;
    //sendText[personId] = cap_data;
    sendText[personId] = cappingText;
    //sendText[personId]["flg"] = 1;
    var json = gadgets.json.stringify(sendText);
    alert(json);

    var req = opensocial.newDataRequest();
    req.add(req.newUpdatePersonAppDataRequest("OWNER", "cap"), json);
    req.add(req.newFetchPersonRequest("OWNER"), "owner");
    req.add(req.newFetchPeopleRequest("OWNER_FRIENDS"), "owner_friends");
    req.add(req.newFetchPersonAppDataRequest("OWNER", "cap"), "owner_cap");
    req.add(req.newFetchPersonAppDataRequest("OWNER_FRIENDS", "cap"), "owner_friends_cap");
    req.send(handleLoadFriends);
}

/**
 *
 *
 */
function validateData(){
    return true;
}

gadgets.util.registerOnLoadHandler(init);
</script>
<div id="select"></div>
<div id="text"><input type="text" id ="capping" name="capping" value="" /><input type="submit" id="btn_submit" name="btn_submit" value="送る"></div>
<div id="friends"></div>
]]>
</Content>
</Module>
