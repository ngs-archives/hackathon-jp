<?xml version="1.0" encoding="UTF-8" ?>
<Module>
	
<ModulePrefs title="みんなのMoSoトラベル" description="写真を使って行った気になるガジェットです。">
	<Require feature="opensocial-0.8"/>
	<Require feature="dynamic-height" />
</ModulePrefs>

<Optional feature="content-rewrite">
	<Param name="exclude-urls">*</Param>
</Optional>

<Content type="html" view="home,profile,canvas">
<![CDATA[
<script src="http://maps.google.com/maps?file=api&amp;v=2&amp;sensor=true&amp;key=ABQIAAAA2Vepkuo8WdQeGcpoCH7R4xRSk02GZpXEMAkEqFagruxbBFc2zRTdCzSQEqe7DmWaTeZNeOcP5ujaEA" type="text/javascript"></script>
<script type="text/javascript" src="http://opensocial-jquery.googlecode.com/svn/trunk/features/opensocial-jquery/opensocial-jquery.min.js"></script>
]]>
</Content>

<Content type="html" view="canvas">
<![CDATA[
<script type="text/javascript">


//外部ホストへフォームデータを送信する
var userID=();
/*$(function(){
	$("#sendBtn").click(function(){
	//フォーム各要素のデータを変数に格納
	var setX=$("#setX").val();
	var setY=$("#setY").val();
	var setPhoto=$("#setPhoto").val();
	var comment=$("#comment").val();
	var kinds=$("#kinds").val();

	//会員IDをリクエストする
	$.ajax({
    	url: '/people/@owner/@self',
    	data: {},
    	dataType: 'data',
    	success: function(people) {
      		var person = people[0];
      		console.info(person.id);
      		console.info(person.nickname);
		userID =person.getID();
    		},
    		error: function(xhr, status, e) {
      		console.info(xhr, status, e);
    		}
  	});

	//外部サーバーへajax通信をおこなう
	$.ajax({
		type:'post'
		url: '',
		data: {
			"id":userID,
			"setX":setX,
			"setY":setY,
			"setPhoto":setPhoto,
			"comment":comment,
			"kinds":kinds
		},
		dataType: 'json',
		cache: true,

		//データ取得に成功した場合の処理を定義
		success: function(data, status) {
		console.log(data, status);
		

		},
		error: function(xhr, status, e) {
		console.info(xhr, status, e);
		}
	});
}
})
})*/

var map = {
	
	setView : function(){
		var map = new GMap2($('#map'));
		var point = new GLatLng(36.03, 139.15);
		
		map.addControl(new GLargeMapControl());	
		map.setCenter(point, 1);
		
		var marker = new GMarker(point, {draggable: true});
		map.addOverlay(marker);
		
		GEvent.addListener(marker, 'mouseout', function() {
			var pnt = marker.getPoint();
			var lng = pnt.lng();
			var lat = pnt.lat();
			
			$('#setX').val(lat);
			$('#setY').val(lng);
		});
	}
}

var albumView = {

	requestAlbums : function() {
		var idspec_params = {};
		idspec_params[opensocial.IdSpec.Field.USER_ID] = opensocial.IdSpec.PersonId.OWNER;
		var idspec = opensocial.newIdSpec(idspec_params);
		var params = {};
		req = new opensocial.newDataRequest();
		req.add(req.newFetchAlbumsRequest(idspec, params), 'albums');
		req.send(albumView.onLoadAlbums);
	},
	onLoadAlbums : function(dataResponse){
		var albums = dataResponse.get('albums').getData();
		albums.each(function(album){
			albumView.listMediaItems(album.getField(opensocial.Album.Field.ID));
		});
	},
	listMediaItems : function(albumId) {
		var idspec_params = {};
		idspec_params[opensocial.IdSpec.Field.USER_ID] = opensocial.IdSpec.PersonId.OWNER;
		var idspec = opensocial.newIdSpec(idspec_params);
		var req = new opensocial.newDataRequest();
		var params = {};
		req.add(req.newFetchMediaItemsRequest(idspec, albumId, params), 'mediaitems');
		req.send(albumView.onLoadMediaItems);
	},
	onLoadMediaItems : function(dataResponse) {
		var data = '<ul id="photos" class="clears">';
		var mediaitems = dataResponse.get('mediaitems').getData();
		
		mediaitems.each(function(mediaitem) {
			data += '<li>';
			data += '<img class="photo" src="' + mediaitem.getField(opensocial.MediaItem.Field.THUMBNAIL_URL) + '" /><br />'+mediaitem.getField(opensocial.MediaItem.Field.TITLE)+'</li>';
		});
		
		data += '</ul>';
		$("#photos").html(data);
		$(".photo").click(function(){
			$(".photo").css({ "border":"1px solid #EEE" });
			$(this).css({ "border":"1px solid #F00" });
			var path = $(this).attr("src").split("?");
			
			$("#setPhoto").val(path[0]);
		});
	}
}

var moso = {
	init : function(){
		//map.setView();
		albumView.requestAlbums();
		
		gadgets.window.adjustHeight(700);
	}
}

gadgets.util.registerOnLoadHandler(moso.init);

</script>
<style type="text/css">
#photoTitle,#mapTitle	{ font-size:14px; padding:3px; border-bottom:1px solid #CCC; }
#map					{ width:500px; height:200px; }
#comment				{ width:500px; height:80px; }

ul#photos				{ list-style:none; }
ul#photos li			{ float:left; margin:0 5px 3px 0; font-size:12px; }
ul#photos li img		{ background:#FFF; border:1px solid #EEE; cursor:pointer; padding:2px; }
ul#photos li img:hover	{ border:1px solid #E30; }


.clears:after			{ content:"."; display:block; height:0; clear:both; visibility:hidden; }
.clears					{ display:inline-table; zoom:100%; }
/* macIE \*/
* html .clears { height: 1%; }
.clears { display: block; }
/* macIE */

</style>
<div id="viewer" style="padding:10px;">
	<h2 id="mapTitle">どこの写真？</h2>
	<div id="map"></div>
	<input type="hidden" id="setX" name="setX" value="" />
	<input type="hidden" id="setY" name="setY" value="" />
	
	<h2 id="photoTitle">あなたの写真</h2>
	<div id="photos"></div>
	<input type="hidden" id="setPhoto" value="" />
	
	<h2 id="photoTitle">コメント</h2>
	<textarea id="comment"></textarea>
	<br />
	
	<select id="kinds">
		<option value="1">妄想</option>
		<option value="2">真実</option>
	</select>
	<br />
	
	<input type="button" id="sendBtn" value="登録する" />
</div>
]]>
</Content>

</Module>